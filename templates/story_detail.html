{% extends "base.html" %}
{% block title %}{{ story.title }}{% endblock %}
{% block content %}
<div class="container mt-4">
  <a href="{% url 'stories:list' %}">&larr; Back to Stories</a>
  <div class="row mt-2">
    <div class="col-lg-8">
      <h1>{{ story.title }}</h1>
      {% if story.author_name %}<p class="text-muted">by {{ story.author_name }}{% if story.published_at %} ¬∑ {{ story.published_at }}{% endif %}</p>{% endif %}
      {% if story.cover %}<img src="{{ story.cover.url }}" class="img-fluid rounded mb-3" alt="{{ story.title }}">{% endif %}
      <article class="lead" style="white-space:pre-wrap">{{ story.body }}</article>

      <div class="mt-3">
        <strong>Tags:</strong>
        {% for t in story.tags.all %}
          <a class="badge text-bg-secondary" href="{% url 'stories:by_tag' t.slug %}">{{ t.name }}</a>
        {% empty %} <span>No tags</span> {% endfor %}
      </div>

      <div class="mt-3 d-flex gap-2 align-items-center">
        <button class="btn btn-sm btn-outline-primary react" data-kind="like">üëç Like <span id="count-like">{{ reactions.like|default:0 }}</span></button>
        <button class="btn btn-sm btn-outline-primary react" data-kind="inspired">üëè Inspired <span id="count-inspired">{{ reactions.inspired|default:0 }}</span></button>
        <button class="btn btn-sm btn-outline-primary react" data-kind="helpful">üí° Helpful <span id="count-helpful">{{ reactions.helpful|default:0 }}</span></button>

        {% if user.is_authenticated %}
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'stories:bookmark' story.slug %}">
            {% if user_bookmarked %}‚òÖ Bookmarked{% else %}‚òÜ Bookmark{% endif %}
          </a>
        {% endif %}
      </div>

      <h4 class="mt-4">Comments</h4>
      <form id="commentForm" class="mb-3">
        {% csrf_token %}
        <input class="form-control mb-2" name="name" placeholder="Your name">
        <textarea class="form-control mb-2" name="text" placeholder="Your comment"></textarea>
        <button class="btn btn-primary">Submit</button>
        <small class="text-muted ms-2" id="commentMsg"></small>
      </form>
      <ul class="list-group">
        {% for c in comments %}
          <li class="list-group-item"><strong>{{ c.name }}</strong><br>{{ c.text }}</li>
        {% empty %}
          <li class="list-group-item">No comments yet.</li>
        {% endfor %}
      </ul>

      <p class="text-muted mt-3">Views: {{ story.views }}</p>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i=0;i<cookies.length;i++){
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length+1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.querySelectorAll(".react").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const kind = btn.dataset.kind;
    const res = await fetch("{% url 'stories:react' story.slug %}", {
      method: "POST",
      headers: {"X-CSRFToken": csrftoken, "Content-Type": "application/x-www-form-urlencoded"},
      body: new URLSearchParams({kind})
    });
    const data = await res.json();
    if(data.ok){
      const el = document.getElementById(`count-${kind}`);
      if(el) el.textContent = data.count;
    }
  });
});

document.getElementById("commentForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch("{% url 'stories:comment' story.slug %}", {
    method: "POST",
    headers: {"X-CSRFToken": csrftoken},
    body: new URLSearchParams(fd)
  });
  const data = await res.json();
  document.getElementById("commentMsg").textContent = data.message || "Submitted";
  e.target.reset();
});
</script>
{% endblock %}
